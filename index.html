<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>ğŸš€ ìµœì¢… ì™„ì„±! ê¸€ë˜ìŠ¤ëª¨í”¼ì¦˜ ë‚´ë¹„ê²Œì´ì…˜ ğŸš€</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Leaflet Routing Machine -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

    <!-- Tailwind CSS (CDN for Demo) -->
    <!-- Note: Using Tailwind CDN is not recommended for production. Install via npm/yarn. -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Daum ìš°í¸ë²ˆí˜¸ ì„œë¹„ìŠ¤ (Use https) -->
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼, ê¸€ë˜ìŠ¤ëª¨í”¼ì¦˜, ë²„íŠ¼ ë“± (ì´ì „ ì½”ë“œì™€ ê±°ì˜ ë™ì¼) */
        :root { --toast-bg: rgba(0, 0, 0, 0.7); --toast-text: white; }
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; } /* html, body ë†’ì´ 100% */
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; flex-direction: column; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }

        /* ì§€ë„ ì»¨í…Œì´ë„ˆ */
        #map-container { flex-grow: 1; position: relative; /* ìì‹ absolute ìš”ì†Œ ê¸°ì¤€ì  */ }
        #map { height: 100%; width: 100%; z-index: 10; } /* ë†’ì´ 100% ëª…ì‹œ */

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        #controls-wrapper { position: absolute; top: 0; left: 0; right: 0; z-index: 20; padding: 0.5rem; pointer-events: none; }
        #controls { background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2); color: #1f2937; border-radius: 0.75rem; padding: 0.75rem; margin: 0 auto; max-width: 600px; width: auto; pointer-events: auto; transition: transform 0.3s ease-out, opacity 0.3s ease-out; }
        #controls.hidden-ui { transform: translateY(-110%); opacity: 0; pointer-events: none; }

        /* UI í† ê¸€ ë²„íŠ¼ */
        #ui-toggle-button { position: absolute; top: 10px; right: 10px; z-index: 25; background: rgba(255, 255, 255, 0.3); backdrop-filter: blur(5px); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 50%; padding: 0.5rem; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        #ui-toggle-button:hover { background: rgba(255, 255, 255, 0.5); }
        #ui-toggle-button svg { width: 1.25rem; height: 1.25rem; color: #374151; stroke-width: 1.5; }

        /* ì…ë ¥ í•„ë“œ, ë²„íŠ¼, íƒ­ ë“± ë‚˜ë¨¸ì§€ ìŠ¤íƒ€ì¼ (ì´ì „ ì½”ë“œ ìœ ì§€) */
        .input-group { display: flex; align-items: center; background: rgba(255, 255, 255, 0.4); border-radius: 8px; padding: 2px; border: 1px solid rgba(255, 255, 255, 0.2); }
        .input-group input { flex-grow: 1; border: none; background: transparent; padding: 8px 10px; outline: none; font-size: 0.9rem; color: #374151;}
        .input-group input::placeholder { color: #6b7280; }
        .input-group button { background: rgba(255, 255, 255, 0.5); border: none; border-radius: 6px; padding: 6px; margin-left: 4px; cursor: pointer; transition: background 0.2s ease; }
        .input-group button:hover { background: rgba(255, 255, 255, 0.7); }
        .input-group svg { width: 1rem; height: 1rem; color: #4b5563; }
        .control-btn { display: flex; align-items: center; justify-content: center; padding: 8px 10px; border-radius: 8px; background: rgba(255, 255, 255, 0.4); border: 1px solid rgba(255, 255, 255, 0.2); color: #374151; font-weight: 500; cursor: pointer; transition: all 0.2s ease; text-align: center; font-size: 0.85rem; }
        .control-btn:hover { background: rgba(255, 255, 255, 0.6); transform: translateY(-1px); }
        .control-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; background: rgba(200, 200, 200, 0.3); }
        .control-btn svg { width: 1rem; height: 1rem; margin-right: 5px; stroke-width: 1.5; }
        .control-btn.active, .profile-btn.active, .map-style-btn.active { background: rgba(59, 130, 246, 0.7); color: white; border-color: rgba(59, 130, 246, 0.5); box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3); }
        .control-btn.active svg, .profile-btn.active svg, .map-style-btn.active svg { color: white; }
        #btn-mic.listening { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.05); } }
        .tab-group { display: flex; background: rgba(255, 255, 255, 0.2); border-radius: 8px; padding: 3px; border: 1px solid rgba(255, 255, 255, 0.1); }
        .tab-group button { flex: 1; padding: 6px 8px; border: none; background: transparent; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; font-size: 0.8rem; font-weight: 500; color: #4b5563; }
        .tab-group button.active { background: rgba(255, 255, 255, 0.7); color: #1f2937; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .loader { border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid #fff; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; margin-left: 6px; vertical-align: middle; }
        #status-container { font-size: 0.8rem; }
        .emoji-marker { font-size: 2rem; text-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        #postcode-layer { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(3px); z-index: 30; }
        #postcode-content-wrapper { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 500px; background: #fff; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); padding-top: 35px; }
        #postcode-content { width: 100%; height: 450px; border-radius: 0 0 12px 12px; overflow: hidden; }
        #btn-close-postcode { cursor: pointer; position: absolute; right: 10px; top: 8px; z-index: 1; font-size: 1.5rem; color: #666; background: transparent; border: none; padding: 0; line-height: 1; }
        #btn-close-postcode:hover { color: #000; }
        #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--toast-bg); color: var(--toast-text); padding: 10px 20px; border-radius: 20px; z-index: 1000; font-size: 0.9rem; opacity: 0; transition: opacity 0.5s ease; pointer-events: none; }
        #toast.show { opacity: 1; pointer-events: auto; }
        .leaflet-routing-container { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(5px); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: #333; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <!-- ì§€ë„ ì»¨í…Œì´ë„ˆ -->
    <div id="map-container">
        <div id="map"></div>

        <!-- UI í† ê¸€ ë²„íŠ¼ -->
        <button id="ui-toggle-button" title="UI ìˆ¨ê¸°ê¸°/ë³´ì´ê¸°">
            <svg id="icon-hide" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 0 0 1.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.451 10.451 0 0 1 12 4.5c4.756 0 8.773 3.162 10.065 7.498a10.522 10.522 0 0 1-4.293 5.774M6.228 6.228 3 3m3.228 3.228 3.65 3.65m7.894 7.894L21 21m-3.228-3.228-3.65-3.65m0 0a3 3 0 1 0-4.243-4.243m4.242 4.242L6.228 6.228" />
            </svg>
             <svg id="icon-show" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="hidden">
               <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" />
               <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
             </svg>
        </button>

        <!-- ìƒë‹¨ ì»¨íŠ¸ë¡¤ íŒ¨ë„ (Wrapper) -->
        <div id="controls-wrapper">
            <div id="controls" class="space-y-3">
                <!-- ì…ë ¥ í•„ë“œ ê·¸ë£¹ -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                    <div class="input-group">
                        <span class="pl-2 text-green-700">ğŸ“</span>
                        <input type="text" id="input-start" placeholder="ì¶œë°œì§€ ê²€ìƒ‰ ë˜ëŠ” ì§€ë„ í´ë¦­">
                        <button id="btn-search-start-input" title="ì¶œë°œì§€ ì£¼ì†Œ ê²€ìƒ‰">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" /></svg>
                        </button>
                    </div>
                    <div class="input-group">
                        <span class="pl-2 text-red-600">ğŸ</span>
                        <input type="text" id="input-end" placeholder="ëª©ì ì§€ ê²€ìƒ‰ ë˜ëŠ” ì§€ë„/ìŒì„± ì…ë ¥">
                        <button id="btn-search-end-input" title="ëª©ì ì§€ ì£¼ì†Œ ê²€ìƒ‰">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" /></svg>
                        </button>
                        <button id="btn-mic" class="control-btn !p-1.5 !ml-1" title="ìŒì„±ìœ¼ë¡œ ëª©ì ì§€ ì…ë ¥">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 0 0 6-6v-1.5m-6 7.5a6 6 0 0 1-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 0 1-3-3V4.5a3 3 0 1 1 6 0v8.25a3 3 0 0 1-3 3Z" /></svg>
                        </button>
                    </div>
                </div>
                <!-- ì§€ë„ í´ë¦­ / í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼ ê·¸ë£¹ -->
                <div class="grid grid-cols-2 gap-2">
                    <button id="btn-click-start" class="control-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.375 17.55a1.5 1.5 0 0 1-1.401 1.415l-3.405-1.513a1.5 1.5 0 0 1-.9-1.317V8.683a1.5 1.5 0 0 1 2.77-.726l4.04 7.498a1.5 1.5 0 0 1-1.104 2.105Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" /></svg>
                       ì§€ë„ ì¶œë°œ
                   </button>
                   <button id="btn-click-end" class="control-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.375 17.55a1.5 1.5 0 0 1-1.401 1.415l-3.405-1.513a1.5 1.5 0 0 1-.9-1.317V8.683a1.5 1.5 0 0 1 2.77-.726l4.04 7.498a1.5 1.5 0 0 1-1.104 2.105Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" /></svg>
                       ì§€ë„ ëª©ì 
                   </button>
                    <button id="btn-current-location" class="control-btn col-span-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" /></svg>
                       ë‚´ ìœ„ì¹˜ë¥¼ ì¶œë°œì§€ë¡œ
                   </button>
               </div>
                <!-- ê²½ë¡œ í”„ë¡œí•„ / ì§€ë„ ìŠ¤íƒ€ì¼ ì„ íƒ ê·¸ë£¹ -->
               <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                   <div>
                        <label class="block text-xs font-medium mb-1">ê²½ë¡œ ìœ í˜•</label>
                        <div class="tab-group" id="profile-tabs">
                            <button data-profile="driving" class="profile-btn">ğŸš— ìë™ì°¨</button>
                            <button data-profile="walking" class="profile-btn">ğŸš¶ ë„ë³´</button>
                            <button data-profile="bike" class="profile-btn">ğŸš² ìì „ê±°</button>
                        </div>
                   </div>
                    <div>
                        <label for="map-style-select" class="block text-xs font-medium mb-1">ì§€ë„ ìŠ¤íƒ€ì¼</label>
                        <select id="map-style-select" class="w-full p-2 rounded-lg bg-white/40 border border-white/20 text-sm text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500/50">
                            <option value="voyager">Voyager (ê¸°ë³¸)</option>
                            <option value="osmDefault">OpenStreetMap</option>
                            <option value="satellite">ìœ„ì„± ì§€ë„</option>
                            <option value="dark">ë‹¤í¬ ëª¨ë“œ</option>
                        </select>
                   </div>
               </div>
                <!-- ê²½ë¡œ ì°¾ê¸° ë²„íŠ¼ -->
               <button id="btn-find-route" class="control-btn w-full mt-3 !bg-blue-600/80 !text-white !font-bold text-base !py-2.5 disabled:!bg-gray-400/50" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.769 59.769 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5" /></svg>
                   ê²½ë¡œ ì•ˆë‚´ ì‹œì‘
               </button>
                <!-- ìƒíƒœ ë©”ì‹œì§€ & ê²½ê³  -->
               <div id="status-container" class="text-center text-xs pt-1">
                    <span id="status" class="text-gray-700">ì¶œë°œì§€ì™€ ëª©ì ì§€ë¥¼ ì„¤ì •í•˜ì„¸ìš”.</span>
                    <span id="loading-indicator" class="hidden font-semibold text-blue-700">ì²˜ë¦¬ ì¤‘... <span class="loader !border-blue-300 !border-t-blue-600"></span></span>
               </div>
                <div class="text-center text-xs text-red-700/80 mt-1 font-medium">âš ï¸ API Key ì—†ì´ ì¢Œí‘œ ë³€í™˜(Nominatim) ì‹œ ìœ„ì¹˜ê°€ ë¶€ì •í™•í•  ìˆ˜ ìˆìœ¼ë©°, ì¦ì€ ì‚¬ìš© ì‹œ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
            </div>
        </div>
    </div>

    <!-- Daum ìš°í¸ë²ˆí˜¸ ë ˆì´ì–´ -->
    <div id="postcode-layer">
        <div id="postcode-content-wrapper">
             <button id="btn-close-postcode" onclick="closeDaumPostcode()">âœ–</button>
            <div id="postcode-content"></div>
        </div>
    </div>

    <!-- í† ìŠ¤íŠ¸ ë©”ì‹œì§€ -->
    <div id="toast"></div>

    <script>
        // --- ì „ì—­ ë³€ìˆ˜ ë° ì´ˆê¸°í™” ---
        let map;
        let currentTileLayer = null;
        let startMarker = null, endMarker = null;
        let startLatLng = null, endLatLng = null;
        let settingMode = null; // 'click-start', 'click-end', 'search-start', 'search-end', 'listening', 'geocoding-voice', null
        let routingControl = null;
        let routingProfile = 'driving';
        let isUIHidden = false;
        let daumPostcodeInstance = null;

        // --- API ê°ì²´ (ì•ˆì „í•˜ê²Œ ì´ˆê¸°í™”) ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        try {
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                 // recognition ì„¤ì • (ì˜µì…˜)
                 recognition.continuous = false; // ë‹¨ì¼ ê²°ê³¼ë§Œ ë°˜í™˜
                 recognition.interimResults = false; // ì¤‘ê°„ ê²°ê³¼ ë°˜í™˜ ì•ˆí•¨
            } else {
                console.warn("Speech Recognition not supported by this browser.");
            }
        } catch (e) {
            console.error("Could not create SpeechRecognition object:", e);
        }

        const synthesis = window.speechSynthesis || null;
        if (!synthesis) {
            console.warn("Speech Synthesis (TTS) not supported by this browser.");
        }

        // --- UI ìš”ì†Œ ---
        const controlsWrapper = document.getElementById('controls-wrapper');
        const controlsPanel = document.getElementById('controls');
        const uiToggleButton = document.getElementById('ui-toggle-button');
        const iconHide = document.getElementById('icon-hide');
        const iconShow = document.getElementById('icon-show');
        const inputStart = document.getElementById('input-start');
        const inputEnd = document.getElementById('input-end');
        const btnSearchStartInput = document.getElementById('btn-search-start-input');
        const btnSearchEndInput = document.getElementById('btn-search-end-input');
        const btnMic = document.getElementById('btn-mic');
        const btnClickStart = document.getElementById('btn-click-start');
        const btnClickEnd = document.getElementById('btn-click-end');
        const btnCurrentLocation = document.getElementById('btn-current-location');
        const btnFindRoute = document.getElementById('btn-find-route');
        const profileTabs = document.getElementById('profile-tabs');
        const mapStyleSelect = document.getElementById('map-style-select');
        const statusText = document.getElementById('status');
        const loadingIndicator = document.getElementById('loading-indicator');
        const mapContainer = document.getElementById('map-container');
        const mapElement = document.getElementById('map');
        const postcodeLayer = document.getElementById('postcode-layer');
        const postcodeContent = document.getElementById('postcode-content');
        const toastElement = document.getElementById('toast');

        // --- ì§€ë„ íƒ€ì¼ ë ˆì´ì–´ ì •ì˜ ---
        const tileLayers = {
             voyager: L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OSM</a> contributors Â© <a href="https://carto.com/attributions">CARTO</a>', subdomains: 'abcd', maxZoom: 20 }),
             osmDefault: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OSM</a> contributors', maxZoom: 19 }),
             satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles Â© Esri â€” Esri, i-cubed, USDA, USGS...', maxZoom: 18 }),
             dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OSM</a> contributors Â© <a href="https://carto.com/attributions">CARTO</a>', subdomains: 'abcd', maxZoom: 20 })
        };

        // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
        function showToast(message, duration = 3000) {
            toastElement.textContent = message;
            toastElement.classList.add('show');
            setTimeout(() => { toastElement.classList.remove('show'); }, duration);
        }
        function speak(text) {
             if (!synthesis) return;
             try {
                if (synthesis.speaking) synthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ko-KR';
                utterance.rate = 1.0;
                synthesis.speak(utterance);
             } catch (e) { console.error("TTS Error:", e); }
        }

        // --- UI ë° ìƒíƒœ ê´€ë¦¬ ---
        function showLoading(message = "ì²˜ë¦¬ ì¤‘...") {
             statusText.classList.add('hidden');
             loadingIndicator.classList.remove('hidden');
             loadingIndicator.firstChild.textContent = message + " ";
        }
        function hideLoading() {
             loadingIndicator.classList.add('hidden');
             statusText.classList.remove('hidden');
        }
        function updateUI(message = null) {
             let statusMsg = message || "";
             if (!message) {
                 if (settingMode === 'click-start') statusMsg = "ì§€ë„ì—ì„œ ğŸ“ ì¶œë°œì§€ë¥¼ í´ë¦­í•˜ì„¸ìš”.";
                 else if (settingMode === 'click-end') statusMsg = "ì§€ë„ì—ì„œ ğŸ ëª©ì ì§€ë¥¼ í´ë¦­í•˜ì„¸ìš”.";
                 else if (settingMode === 'listening') statusMsg = "ğŸ¤ ëª©ì ì§€ë¥¼ ë§ì”€í•´ì£¼ì„¸ìš”...";
                 else if (settingMode === 'geocoding-voice') statusMsg = "ğŸ—£ï¸ ìŒì„± ì¸ì‹ëœ ì£¼ì†Œ ì¢Œí‘œ ì°¾ëŠ” ì¤‘...";
                 else if (settingMode?.startsWith('search')) statusMsg = currentSearchType === 'start' ? 'ğŸ“® ì¶œë°œì§€ ì£¼ì†Œë¥¼ ê²€ìƒ‰ ì¤‘...' : 'ğŸ“® ëª©ì ì§€ ì£¼ì†Œë¥¼ ê²€ìƒ‰ ì¤‘...';
                 else if (!startLatLng && !endLatLng) statusMsg = "ì¶œë°œ/ëª©ì ì§€ë¥¼ ì„¤ì •í•˜ì„¸ìš”.";
                 else if (!startLatLng) statusMsg = "ğŸ“ ì¶œë°œì§€ë¥¼ ì„¤ì •í•˜ì„¸ìš”.";
                 else if (!endLatLng) statusMsg = "ğŸ ëª©ì ì§€ë¥¼ ì„¤ì •í•˜ì„¸ìš”.";
                 else statusMsg = "âœ… ê²½ë¡œ íƒìƒ‰ ì¤€ë¹„ ì™„ë£Œ!";
             }
             statusText.textContent = statusMsg;

             // ê²½ë¡œ ì°¾ê¸° ë²„íŠ¼ í™œì„±í™” ì¡°ê±´ í™•ì¸ ë° ë””ë²„ê¹… ë¡œê·¸
             const isRouteReady = startLatLng instanceof L.LatLng && endLatLng instanceof L.LatLng;
             btnFindRoute.disabled = !isRouteReady;
             console.log(`updateUI: startLatLng=${startLatLng ? `[${startLatLng.lat}, ${startLatLng.lng}]` : 'null'}, endLatLng=${endLatLng ? `[${endLatLng.lat}, ${endLatLng.lng}]` : 'null'}, Route Ready=${isRouteReady}, Button Disabled=${btnFindRoute.disabled}`);

             // ê¸°íƒ€ UI ìƒíƒœ ì—…ë°ì´íŠ¸
             mapElement.classList.toggle('setting-mode-cursor', settingMode === 'click-start' || settingMode === 'click-end');
             btnMic.classList.toggle('listening', settingMode === 'listening');
             [btnClickStart, btnClickEnd].forEach(btn => btn.classList.remove('active'));
             if (settingMode === 'click-start') btnClickStart.classList.add('active');
             if (settingMode === 'click-end') btnClickEnd.classList.add('active');

             hideLoading(); // ë¡œë”© í‘œì‹œ ìˆ¨ê¹€
        }
        function toggleUI() {
             isUIHidden = !isUIHidden;
             controlsPanel.classList.toggle('hidden-ui', isUIHidden);
             iconHide.classList.toggle('hidden', isUIHidden);
             iconShow.classList.toggle('hidden', !isUIHidden);
             uiToggleButton.setAttribute('title', isUIHidden ? 'UI ë³´ì´ê¸°' : 'UI ìˆ¨ê¸°ê¸°');
             if (map) { setTimeout(() => map.invalidateSize({ animate: true }), 310); }
        }

        // --- ë§ˆì»¤ ê´€ë ¨ (ì´ëª¨ì§€) ---
        function createOrUpdateMarker(type, latlng, popupContent, openPopup = true) {
             // ì¢Œí‘œ ìœ íš¨ì„± ê²€ì‚¬
             if (!(latlng && typeof latlng.lat === 'number' && typeof latlng.lng === 'number')) {
                 console.error("Invalid LatLng object passed to createOrUpdateMarker:", latlng);
                 showToast("ì˜ëª»ëœ ìœ„ì¹˜ ì •ë³´ì…ë‹ˆë‹¤.");
                 if (settingMode?.startsWith('click')) settingMode = null; // í´ë¦­ ëª¨ë“œë§Œ í•´ì œ
                 updateUI("ìœ„ì¹˜ ì„¤ì • ì˜¤ë¥˜"); // UI ì—…ë°ì´íŠ¸
                 return;
             }
             const validLatLng = L.latLng(latlng.lat, latlng.lng);
             console.log(`createOrUpdateMarker called for ${type} at [${validLatLng.lat}, ${validLatLng.lng}]`);

             const emoji = type === 'start' ? 'ğŸ“' : 'ğŸ';
             const customIcon = L.divIcon({
                 html: `<span class="emoji-marker">${emoji}</span>`,
                 className: '', iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -35]
             });

             let targetMarker = type === 'start' ? startMarker : endMarker;
             if (targetMarker) {
                 console.log(`Removing previous ${type} marker.`);
                 map.removeLayer(targetMarker);
             }

             const newMarker = L.marker(validLatLng, { icon: customIcon }).addTo(map).bindPopup(popupContent);
             console.log(`${type} marker created.`);

             // ìƒíƒœ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
             if (type === 'start') {
                 startMarker = newMarker;
                 startLatLng = validLatLng;
                 console.log("startLatLng updated:", startLatLng);
             } else {
                 endMarker = newMarker;
                 endLatLng = validLatLng;
                 console.log("endLatLng updated:", endLatLng);
             }

             if (openPopup) {
                 setTimeout(() => {
                     if (newMarker && map.hasLayer(newMarker)) {
                         newMarker.openPopup();
                     }
                 }, 100);
             }

             // ëª¨ë“œ í•´ì œ (í´ë¦­ ëª¨ë“œì¼ ë•Œë§Œ) ë° UI ì—…ë°ì´íŠ¸
             if (settingMode?.startsWith('click')) {
                 console.log(`Resetting settingMode from ${settingMode} to null`);
                 settingMode = null;
             }
             updateUI(); // ìƒíƒœ ë³€ê²½ í›„ UI ê°±ì‹  í˜¸ì¶œ
        }


        // --- ì£¼ì†Œ ê²€ìƒ‰ (Daum + Nominatim) ---
        function openDaumPostcode(searchType) {
             if (typeof daum === 'undefined' || typeof daum.Postcode === 'undefined') {
                 showToast("ì£¼ì†Œ ê²€ìƒ‰ ì„œë¹„ìŠ¤ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", 5000);
                 return;
             }
             currentSearchType = searchType;
             settingMode = `search-${searchType}`;
             updateUI();
             postcodeContent.innerHTML = '';

             try {
                if (!daumPostcodeInstance) {
                    daumPostcodeInstance = new daum.Postcode({
                        oncomplete: handleDaumPostcodeComplete,
                        onclose: handleDaumPostcodeClose,
                        width: '100%', height: '100%', maxSuggestItems: 5,
                        theme: { searchBgColor: "#F0F4F8", queryTextColor: "#333" }
                    });
                }
                daumPostcodeInstance.embed(postcodeContent);
                postcodeLayer.style.display = 'block';
             } catch (error) {
                 console.error("Error opening Daum Postcode:", error);
                 showToast("ì£¼ì†Œ ê²€ìƒ‰ ì°½ì„ ì—¬ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                 settingMode = null;
                 updateUI();
             }
        }
        function handleDaumPostcodeComplete(data) {
             let fullAddress = data.roadAddress || data.jibunAddress;
             const simplifiedAddress = data.buildingName || fullAddress?.split(' ')?.slice(0, 3)?.join(' ') || "ì„ íƒëœ ì£¼ì†Œ"; // ì£¼ì†Œ íŒŒì‹± ì˜¤ë¥˜ ëŒ€ë¹„
             console.log("Daum Postcode Data:", data);
             closeDaumPostcode(); // ê²°ê³¼ ì²˜ë¦¬ ì‹œì‘ ì‹œ ë¨¼ì € ë‹«ê¸°

             if (fullAddress) {
                 showLoading(`${currentSearchType === 'start' ? 'ğŸ“' : 'ğŸ'} '${simplifiedAddress}' ì¢Œí‘œ ì°¾ëŠ” ì¤‘...`);
                 geocodeAddressNominatim(fullAddress, (latlng) => {
                     if (latlng) {
                         const markerType = currentSearchType; // í´ë¡œì € ë³€ìˆ˜
                         const popupText = `${markerType === 'start' ? 'ğŸ“ ì¶œë°œ' : 'ğŸ ëª©ì '}: ${data.buildingName || fullAddress}`;
                         if(markerType === 'start') inputStart.value = simplifiedAddress;
                         else inputEnd.value = simplifiedAddress;

                         createOrUpdateMarker(markerType, latlng, popupText); // ë‚´ë¶€ì—ì„œ latlng ì„¤ì • ë° updateUI í˜¸ì¶œ
                         if (map) map.setView(latlng, 16);
                         speak(`${markerType === 'start' ? 'ì¶œë°œì§€' : 'ëª©ì ì§€'} ${simplifiedAddress} ì„¤ì • ì™„ë£Œ`);
                         // updateUIëŠ” createOrUpdateMarker ë‚´ë¶€ì—ì„œ í˜¸ì¶œë¨
                     } else {
                         speak("ì£„ì†¡í•©ë‹ˆë‹¤. í•´ë‹¹ ì£¼ì†Œì˜ ì¢Œí‘œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                         showToast(`'${simplifiedAddress}'ì˜ ì¢Œí‘œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (Nominatim).`, 5000);
                         updateUI("ì¢Œí‘œ ë³€í™˜ ì‹¤íŒ¨."); // updateUI í˜¸ì¶œ
                     }
                     settingMode = null; // ì§€ì˜¤ì½”ë”© ì‹œë„ í›„ ëª¨ë“œ í•´ì œ
                     hideLoading(); // ë¡œë”© ìˆ¨ê¹€
                 });
             } else {
                 showToast("ì£¼ì†Œ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                 settingMode = null;
                 updateUI(); // updateUI í˜¸ì¶œ
                 hideLoading();
             }
        }
        function handleDaumPostcodeClose(state) {
             if (state !== 'COMPLETE_CLOSE') {
                 closeDaumPostcode();
                 if (settingMode?.startsWith('search')) {
                     settingMode = null;
                     updateUI();
                 }
             }
        }
        function closeDaumPostcode() {
             postcodeLayer.style.display = 'none';
        }
        async function geocodeAddressNominatim(address, callback) {
             // Nominatim ì‚¬ìš© ê²½ê³  ë° ë”œë ˆì´
             console.warn("Nominatim API í˜¸ì¶œ: ì‚¬ìš©ëŸ‰ ì œí•œ ì£¼ì˜!", address);
             const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1&countrycodes=kr`;
             try {
                 await new Promise(resolve => setTimeout(resolve, 500)); // ìš”ì²­ ì§€ì—°
                 const response = await fetch(url, { headers: { 'User-Agent': 'MyLeafletNavApp/1.0 (myemail@example.com)' } });
                 if (!response.ok) throw new Error(`Nominatim API Error: ${response.statusText} (${response.status})`);
                 const data = await response.json();
                 if (data && data.length > 0 && data[0].lat && data[0].lon) {
                     const lat = parseFloat(data[0].lat);
                     const lon = parseFloat(data[0].lon);
                     if (lat >= -90 && lat <= 90 && lon >= -180 && lon <= 180) {
                         callback(L.latLng(lat, lon)); // L.latLng ê°ì²´ ë°˜í™˜
                     } else { callback(null); }
                 } else { callback(null); }
             } catch (error) {
                 console.error("Nominatim Geocoding Failed:", error);
                 callback(null);
             }
        }

        // --- ìŒì„± ì¸ì‹ ---
        function startSpeechRecognition() {
             if (!recognition) {
                 showToast("ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤. ğŸ˜¥");
                 speak("ì£„ì†¡í•©ë‹ˆë‹¤. ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìŒì„± ì¸ì‹ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                 if (btnMic) btnMic.disabled = true;
                 return;
             }
             if (settingMode === 'listening' || settingMode === 'geocoding-voice') return; // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€

             settingMode = 'listening';
             updateUI();
             showToast("ë§ˆì´í¬ ê¶Œí•œì„ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.", 2000);
             speak("ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ëª©ì ì§€ë¥¼ ë§ì”€í•´ì£¼ì„¸ìš”.");

             recognition.onresult = null; recognition.onerror = null; recognition.onend = null; // ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™”

             recognition.lang = 'ko-KR';

             recognition.onresult = async (event) => {
                 const transcript = event.results[0][0].transcript;
                 console.log('ìŒì„± ì¸ì‹ ê²°ê³¼:', transcript);
                 inputEnd.value = transcript;
                 settingMode = 'geocoding-voice';
                 updateUI();
                 showLoading(`ğŸ—£ï¸ '${transcript}' ì¢Œí‘œ ì°¾ëŠ” ì¤‘...`);
                 speak(`${transcript} ì£¼ì†Œë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤.`);

                 try {
                     // 1. í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
                     const pos = await getCurrentLocationPromise();
                     if (!(pos && pos.latlng)) throw new Error("Invalid location data received.");
                     const currentLatLng = L.latLng(pos.latlng.lat, pos.latlng.lng);
                     createOrUpdateMarker('start', currentLatLng, 'ğŸ“ í˜„ì¬ ìœ„ì¹˜ (ì¶œë°œ)', false);
                     console.log('í˜„ì¬ ìœ„ì¹˜ ì„¤ì • ì™„ë£Œ:', startLatLng); // startLatLngì€ createOrUpdateMarkerì—ì„œ ì„¤ì •ë¨

                     // 2. ìŒì„± ì¸ì‹ëœ ì£¼ì†Œ ì§€ì˜¤ì½”ë”©
                     geocodeAddressNominatim(transcript, (endGeoLatLng) => {
                         hideLoading(); // ì§€ì˜¤ì½”ë”© ì‹œë„ í›„ ë¡œë”© ìˆ¨ê¹€
                         if (endGeoLatLng) {
                             createOrUpdateMarker('end', endGeoLatLng, `ğŸ ëª©ì : ${transcript}`, false);
                             console.log('ìŒì„± ëª©ì ì§€ ì„¤ì • ì™„ë£Œ:', endLatLng); // endLatLngì€ createOrUpdateMarkerì—ì„œ ì„¤ì •ë¨
                             speak(`${transcript} ëª©ì ì§€ ì„¤ì • ì™„ë£Œ. ê²½ë¡œ íƒìƒ‰ì„ ì‹œì‘í•©ë‹ˆë‹¤.`);
                             updateUI("âœ… ìŒì„± ëª©ì ì§€ ì„¤ì • ì™„ë£Œ."); // updateUI í˜¸ì¶œ
                             // 3. ê²½ë¡œ íƒìƒ‰ ì‹œì‘ (ì¢Œí‘œ ì„¤ì • ì™„ë£Œ í™•ì¸ í›„)
                             if (startLatLng && endLatLng) {
                                findRoute();
                             } else {
                                console.error("Start or End LatLng not set after voice recognition flow.");
                                showToast("ê²½ë¡œ íƒìƒ‰ ì‹œì‘ ì‹¤íŒ¨: ìœ„ì¹˜ ì •ë³´ ë¶€ì¡±");
                             }
                         } else {
                             speak(`ì£„ì†¡í•©ë‹ˆë‹¤. ${transcript} ìœ„ì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                             showToast(`'${transcript}' ì¢Œí‘œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ğŸ˜¥`, 5000);
                             updateUI("ìŒì„± ì¸ì‹ ì£¼ì†Œ ì¢Œí‘œ ë³€í™˜ ì‹¤íŒ¨."); // updateUI í˜¸ì¶œ
                         }
                         settingMode = null; // ì§€ì˜¤ì½”ë”© ì‹œë„ í›„ ëª¨ë“œ í•´ì œ
                     });

                 } catch (error) {
                     hideLoading();
                     settingMode = null;
                     let errorMsg = "í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì–´ ê²½ë¡œ íƒìƒ‰ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                      if (error && error.message && error.message.includes("permission denied")) {
                           errorMsg = "ìœ„ì¹˜ ì •ë³´ ì ‘ê·¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.";
                      } else if (error && error.message) {
                          errorMsg = `ìœ„ì¹˜ ì˜¤ë¥˜: ${error.message}`;
                      }
                     speak(errorMsg);
                     showToast(errorMsg, 4000);
                     updateUI("í˜„ì¬ ìœ„ì¹˜ ì˜¤ë¥˜.");
                     console.error("Location or Geocoding Error in Voice Recognition:", error);
                 }
             };

             recognition.onerror = (event) => { /* ... ì´ì „ê³¼ ë™ì¼ (ì˜¤ë¥˜ ë©”ì‹œì§€, ëª¨ë“œ í•´ì œ, UI ì—…ë°ì´íŠ¸) ... */ };
             recognition.onend = () => { /* ... ì´ì „ê³¼ ë™ì¼ (ëª¨ë“œ í•´ì œ, UI ì—…ë°ì´íŠ¸) ... */ };

             try { recognition.start(); } catch (e) { /* ... ì˜¤ë¥˜ ì²˜ë¦¬ ... */ }
        }
        function getCurrentLocationPromise() {
             return new Promise((resolve, reject) => {
                 if (!navigator.geolocation) { reject(new Error("Geolocation not supported.")); return; }
                 navigator.geolocation.getCurrentPosition(
                     (position) => { resolve({ latlng: { lat: position.coords.latitude, lng: position.coords.longitude } }); }, // Plain object ë°˜í™˜
                     (error) => { reject(error); },
                     { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                 );
             });
        }

        // --- ê²½ë¡œ íƒìƒ‰ ---
        function findRoute() {
             if (!(startLatLng instanceof L.LatLng && endLatLng instanceof L.LatLng)) {
                 showToast("ì¶œë°œì§€ì™€ ëª©ì ì§€ ìœ„ì¹˜ë¥¼ ëª¨ë‘ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.");
                 console.error("findRoute aborted: Invalid start or end LatLng.", startLatLng, endLatLng);
                 return;
             }
             const profileEmoji = routingProfile === 'driving' ? 'ğŸš—' : (routingProfile === 'walking' ? 'ğŸš¶' : 'ğŸš²');
             showLoading(`${profileEmoji} ê²½ë¡œ íƒìƒ‰ ì¤‘...`);
             speak(`ì„ íƒí•˜ì‹  ${routingProfile === 'driving' ? 'ìë™ì°¨' : (routingProfile === 'walking' ? 'ë„ë³´' : 'ìì „ê±°')} ê²½ë¡œë¥¼ íƒìƒ‰í•©ë‹ˆë‹¤.`);

            if (routingControl) map.removeControl(routingControl);

             const router = L.Routing.osrmv1({ /* ... OSRM ì˜µì…˜ ë™ì¼ ... */ });

            routingControl = L.Routing.control({
                 waypoints: [startLatLng, endLatLng],
                 router: router,
                 routeWhileDragging: false, show: true, addWaypoints: false, draggableWaypoints: false, fitSelectedRoutes: true,
                 lineOptions: { styles: [{ color: '#007AFF', opacity: 0.8, weight: 7 }] },
                 createMarker: () => null,
                 summaryTemplate: '<div class="leaflet-routing-summary"><h2>{name}</h2><h3>ê±°ë¦¬: {distance}, ì˜ˆìƒ ì‹œê°„: {time}</h3></div>'
             })
             .on('routesfound', function(e) { /* ... ë™ì¼ ... */ })
             .on('routingerror', function(e) { /* ... ë™ì¼ (ê°œì„ ëœ ì˜¤ë¥˜ ì²˜ë¦¬) ... */ })
             .addTo(map);
        }

        // --- ì§€ë„ ìŠ¤íƒ€ì¼ ë³€ê²½ ---
        function setMapStyle(styleKey) {
             if (!tileLayers[styleKey] || currentTileLayer === tileLayers[styleKey]) return;
             if (currentTileLayer) { map.removeLayer(currentTileLayer); }
             currentTileLayer = tileLayers[styleKey];
             currentTileLayer.addTo(map).on('load', () => console.log(`Tile layer '${styleKey}' loaded.`));
             console.log("Map style changed to:", styleKey);
        }

        // --- ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        document.addEventListener('DOMContentLoaded', () => {
             console.log("DOM Loaded. Initializing...");
             try {
                 // ì§€ë„ ê°ì²´ ìƒì„±
                 map = L.map('map', { zoomControl: false }).setView([36.5, 127.5], 7);
                 console.log("Map object created.");
                 L.control.zoom({ position: 'bottomright' }).addTo(map);

                 // ê¸°ë³¸ ì§€ë„ ìŠ¤íƒ€ì¼ ë¡œë“œ
                 setMapStyle('voyager');

                 // ì§€ë„ê°€ ì¤€ë¹„ë˜ë©´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                 map.whenReady(() => {
                     console.log("Map is ready. Setting up listeners...");

                     // UI í† ê¸€ ë¦¬ìŠ¤ë„ˆ
                     uiToggleButton.onclick = toggleUI;

                     // ì£¼ì†Œ ê²€ìƒ‰ ë¦¬ìŠ¤ë„ˆ
                     btnSearchStartInput.onclick = () => openDaumPostcode('start');
                     inputStart.addEventListener('keypress', (e) => { if (e.key === 'Enter') openDaumPostcode('start'); });
                     btnSearchEndInput.onclick = () => openDaumPostcode('end');
                     inputEnd.addEventListener('keypress', (e) => { if (e.key === 'Enter') openDaumPostcode('end'); });

                     // ì§€ë„ í´ë¦­ ëª¨ë“œ ë¦¬ìŠ¤ë„ˆ
                     btnClickStart.onclick = () => { settingMode = 'click-start'; console.log("Setting mode to click-start"); updateUI(); };
                     btnClickEnd.onclick = () => { settingMode = 'click-end'; console.log("Setting mode to click-end"); updateUI(); };

                     // ì§€ë„ í´ë¦­ ì´ë²¤íŠ¸
                     map.on('click', (e) => {
                         const clickedLatLng = e.latlng;
                         console.log(`Map clicked at [${clickedLatLng.lat}, ${clickedLatLng.lng}], Current mode: ${settingMode}`);
                         if (settingMode === 'click-start') {
                             inputStart.value = `${clickedLatLng.lat.toFixed(5)}, ${clickedLatLng.lng.toFixed(5)}`;
                             createOrUpdateMarker('start', clickedLatLng, `ğŸ“ ì¶œë°œ<br>${inputStart.value}`);
                         } else if (settingMode === 'click-end') {
                             inputEnd.value = `${clickedLatLng.lat.toFixed(5)}, ${clickedLatLng.lng.toFixed(5)}`;
                             createOrUpdateMarker('end', clickedLatLng, `ğŸ ë„ì°©<br>${inputEnd.value}`);
                         }
                     });

                     // í˜„ì¬ ìœ„ì¹˜ ë¦¬ìŠ¤ë„ˆ
                     btnCurrentLocation.onclick = async () => {
                         showLoading("í˜„ì¬ ìœ„ì¹˜ ì°¾ëŠ” ì¤‘...");
                         try {
                             const pos = await getCurrentLocationPromise();
                             if (!(pos && pos.latlng)) throw new Error("Invalid location data.");
                             const currentLatLng = L.latLng(pos.latlng.lat, pos.latlng.lng); // L.latLngë¡œ ë³€í™˜
                             inputStart.value = "í˜„ì¬ ìœ„ì¹˜";
                             createOrUpdateMarker('start', currentLatLng, 'ğŸ“ í˜„ì¬ ìœ„ì¹˜ (ì¶œë°œ)');
                             hideLoading();
                             updateUI("í˜„ì¬ ìœ„ì¹˜ë¥¼ ì¶œë°œì§€ë¡œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.");
                             speak("í˜„ì¬ ìœ„ì¹˜ë¥¼ ì¶œë°œì§€ë¡œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.");
                         } catch (error) {
                             hideLoading();
                             let errorMsg = "í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                             if (error.code === 1) errorMsg = "ìœ„ì¹˜ ì •ë³´ ì ‘ê·¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.";
                             else if (error.code === 2) errorMsg = "ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                             else if (error.code === 3) errorMsg = "ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.";
                             console.error("Geolocation Error:", error);
                             speak(errorMsg);
                             showToast(errorMsg, 4000);
                             updateUI("í˜„ì¬ ìœ„ì¹˜ ì˜¤ë¥˜.");
                         }
                     };

                     // ìŒì„± ì¸ì‹ ë¦¬ìŠ¤ë„ˆ
                     if (recognition) { btnMic.onclick = startSpeechRecognition; }
                     else { if(btnMic) { btnMic.disabled = true; btnMic.title = "ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤."; } }

                     // ê²½ë¡œ í”„ë¡œí•„ ë¦¬ìŠ¤ë„ˆ
                     profileTabs.addEventListener('click', (e) => {
                         const button = e.target.closest('.profile-btn');
                         if (button && button.dataset.profile && button.dataset.profile !== routingProfile) {
                             routingProfile = button.dataset.profile;
                             profileTabs.querySelectorAll('.profile-btn').forEach(btn => btn.classList.remove('active'));
                             button.classList.add('active');
                             console.log("Routing profile set to:", routingProfile);
                             if (routingControl && startLatLng && endLatLng) findRoute();
                         }
                     });

                     // ì§€ë„ ìŠ¤íƒ€ì¼ ë¦¬ìŠ¤ë„ˆ
                     mapStyleSelect.onchange = (e) => setMapStyle(e.target.value);

                     // ê²½ë¡œ ì°¾ê¸° ë¦¬ìŠ¤ë„ˆ
                     btnFindRoute.onclick = findRoute;

                     // ì´ˆê¸° UI ì„¤ì •
                     profileTabs.querySelector(`[data-profile="${routingProfile}"]`)?.classList.add('active'); // null ì²´í¬ ì¶”ê°€
                     updateUI();

                     // Daum ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ í™•ì¸
                     if (typeof daum === 'undefined' || typeof daum.Postcode === 'undefined') {
                         console.error("Daum Postcode ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨!");
                         showToast("ì£¼ì†Œ ê²€ìƒ‰ ì„œë¹„ìŠ¤ ë¡œë“œ ì‹¤íŒ¨!", 5000);
                         if(btnSearchStartInput) btnSearchStartInput.disabled = true;
                         if(btnSearchEndInput) btnSearchEndInput.disabled = true;
                     } else { console.log("Daum Postcode script loaded."); }

                     console.log("Initialization complete. Event listeners set.");

                 }); // end map.whenReady

             } catch (error) {
                 console.error("Map Initialization Failed:", error);
                 alert("ì§€ë„ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
                 document.body.innerHTML = '<div style="padding: 20px; text-align: center; color: red;">ì§€ë„ ë¡œë”© ì‹¤íŒ¨! ê°œë°œì ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.</div>';
             }
        }); // end DOMContentLoaded

    </script>
</body>
</html>
